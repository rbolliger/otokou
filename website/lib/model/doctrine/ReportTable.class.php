<?php

/**
 * ReportTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ReportTable extends Doctrine_Table {

    /**
     * Returns an instance of this class.
     *
     * @return object ReportTable
     */
    public static function getInstance() {
        return Doctrine_Core::getTable('Report');
    }

    public static function findNewByUser($params) {

        $username = $params['username'];

        $q = self::getInstance()->createQuery('r')
                ->andWhere('r.is_new = ?', true)
                ->orderBy('r.created_at ASC');

        $q = $this->addUsernameQuery($username, $q);


        return $q->execute();
    }

    public static function findByUserAndVehicleSlug($params) {

        $username = $params['username'];
        $vehicle_slug = $params['slug'];

        $q = self::getInstance()->createQuery('r')
                ->leftJoin('r.Vehicles v')
                ->andWhere('v.slug = ?', $vehicle_slug)
                ->andWhere('r.num_vehicles = ?', 1)
                ->orderBy('r.created_at ASC');

        $q = self::getInstance()->addUsernameQuery($username, $q);


        return $q->execute();
    }

    public static function findCustomReportsByUser($params) {

        $username = $params['username'];
        $max = $params['max'] ? $params['max'] : 10;

        $q = self::getInstance()->createQuery('r')
                ->andWhere('r.num_vehicles > ?', 1)
                ->orderBy('r.created_at ASC');

        $q = self::getInstance()->addUsernameQuery($username, $q);

        $q->limit($max);

        return $q->execute();
    }

    public function addUsernameQuery($username, Doctrine_Query $q = null) {
        
        if (is_null($q)) {
            $q = Doctrine_Query::create()
                    ->from('Report r');
        }
        
        
        $root = $q->getRootAlias();

        $q->leftJoin($root . '.User u')
                ->andWhere('u.username = ?', $username);

        return $q;
    }

    public function retrieveOrderedReport(Doctrine_Query $q) {
        return $this->addOrderedReportsQuery($q)->fetchOne();
    }

    public function getOrderedReports(Doctrine_Query $q = null) {
        return $this->addOrderedReportsQuery($q)->execute();
    }

    public function countOrderedReports(Doctrine_Query $q = null) {
        return $this->addOrderedReportsQuery($q)->count();
    }

    public function addOrderedReportsQuery(Doctrine_Query $q = null) {
        if (is_null($q)) {
            $q = Doctrine_Query::create()
                    ->from('Report r');
        }

        $alias = $q->getRootAlias();

        $q->addOrderBy('r.is_new DESC, r.created_at DESC');

        return $q;
    }

}